# hajimu_engine_3d  v2.0.0

> **はじむ言語**向け Unity レベル 3D エンジン — SDL2 + OpenGL 3.3 Core Profile

PCF ソフトシャドウ・法線マップ・スポットライト・フォグ・スカイボックス・パーティクル・  
シーングラフ・キーフレームアニメーション・レイキャスト・ブルームを統合した  
3D ゲーム / 可視化アプリ向けプラグインです。

---

## 機能 (v2.0.0)

| カテゴリ | 内容 |
|---|---|
| ウィンドウ | OpenGL 3.3 Core Profile ウィンドウ・リサイズ対応 |
| カメラ | 位置・注視点・FOV・ニア/ファー・ベクトル取得 |
| メッシュ | キューブ / 球 / 平面 / **円柱 / カプセル / トーラス** + OBJ 読込 |
| マテリアル | カラー・テクスチャ・**法線マップ**・スペキュラー・**発光**・ワイヤーフレーム・透明 |
| テクスチャ | PNG / JPG / BMP 読込 (stb_image) |
| 照明 | 環境光 / 平行光 / **ポイントライト ×8** / **スポットライト ×4** (内外コーン) |
| **シャドウ** | PCF ソフトシャドウ (2048² デプスマップ)・キャスト/レシーブ制御 |
| **フォグ** | 線形 / 指数 / 指数2 の 3 モード |
| **スカイボックス** | キューブマップ 6 面読込・描画 |
| **ブルーム** | HDR FBO + Gaussian ブラー + Reinhard トーンマッピング |
| **パーティクル** | CPU エミッター・インスタンス描画・カラー補間・重力 |
| **シーングラフ** | 親子ノード・ワールド行列計算 |
| **キーフレームアニメ** | 位置/回転/スケール キー・線形補間・ループ |
| **レイキャスト** | スクリーン→ワールドレイ・AABB 衝突 |
| 入力 | キーボード / マウス位置・Delta・ボタン・スクロール・相対モード |
| 時間 | デルタ時間 / FPS |

## 依存ライブラリ

| ライブラリ | 用途 | 入手方法 |
|---|---|---|
| SDL2 | ウィンドウ / 入力 / GL コンテキスト | `brew install sdl2` |
| OpenGL 3.3 | GPU 描画 | macOS / Linux 標準 |
| stb_image | テクスチャ読込 | `make vendor` で自動取得 |

---

## インストール

### ✅ 推奨: はじむパッケージマネージャー

```bash
hajimu パッケージ 追加 ReoShiozawa/hajimu_engine_3d
```

インストール後すぐに使えます:

```jp
プラグイン読込("engine_3d")
```

### ソースからビルド

```bash
# 依存ライブラリ (macOS)
brew install sdl2

# リポジトリをクローン
git clone https://github.com/ReoShiozawa/hajimu_engine_3d.git
cd hajimu_engine_3d

make          # stb_image 取得 + ビルド → build/engine_3d.hjp
make install  # → ~/.hajimu/plugins/engine_3d/
```

---

## クイックスタート

```jp
プラグイン読込("engine_3d")

3Dウィンドウ作成("はじむ 3D", 800, 600)
3D視野設定(60, 0.1, 1000)
3Dカメラ設定(0, 3, 8,   0, 0, 0)

// シャドウ有効
3Dシャドウ有効(真)

// スカイボックス
3Dスカイボックス読込("right.png","left.png","top.png","bottom.png","front.png","back.png")
3Dスカイボックス描画(真)

// メッシュ
箱 = 3Dキューブ作成(1, 1, 1)
床 = 3D平面作成(10, 10)
3Dメッシュ色設定(箱, 0.2, 0.6, 1.0, 1.0)
3Dメッシュ色設定(床, 0.4, 0.4, 0.4, 1.0)
3D影投射設定(箱, 真)
3D影受取設定(床, 真)

// ライト
3D環境光設定(0.15, 0.15, 0.15)
3D平行光設定(0.4, -1.0, 0.3,   1.0, 0.95, 0.85)

// ブルーム
3Dブルーム有効(真)
3Dブルーム閾値(0.8)
3D発光設定(箱, 0.3, 0.6, 1.0, 0.5)

角度 = 0

ループ {
  もし(3D更新() == 偽) { 抜ける }

  角度 = 角度 + 30 * 3Dデルタ時間()

  3D描画開始(0.05, 0.05, 0.1)
    3Dメッシュ描画(箱, 0, 0.5, 0,   0, 角度, 0,   1, 1, 1)
    3Dメッシュ描画(床, 0, 0,   0,   0, 0,     0,   1, 1, 1)
  3D描画終了()
}

3Dウィンドウ削除()
```

---

## 使用例

### OBJ モデル + 法線マップ + シャドウ

```jp
プラグイン読込("engine_3d")

3Dウィンドウ作成("モデルビューア", 1280, 720)
3D視野設定(60, 0.1, 500)
3Dカメラ設定(0, 2, 5,  0, 0, 0)

3D環境光設定(0.1, 0.1, 0.1)
3D平行光設定(0.3, -1.0, 0.5,  1.0, 0.95, 0.85)
3Dシャドウ有効(真)

モデル = 3DOBJ読込("model.obj")
テクスチャ = 3Dテクスチャ読込("albedo.png")
法線 = 3Dテクスチャ読込("normal.png")
3Dメッシュテクスチャ(モデル, テクスチャ)
3D法線マップ設定(モデル, 法線)
3Dスペキュラー設定(モデル, 0.6, 32)
3D影投射設定(モデル, 真)

ループ {
  もし(3D更新() == 偽) { 抜ける }
  3D描画開始(0.1, 0.1, 0.15)
  3Dメッシュ描画(モデル, 0,0,0,  0,0,0,  1,1,1)
  3D描画終了()
}
3Dウィンドウ削除()
```

### パーティクル炎

```jp
プラグイン読込("engine_3d")

3Dウィンドウ作成("炎パーティクル", 800, 600)
3Dカメラ設定(0, 2, 6,  0, 1, 0)
3D環境光設定(0.05, 0.05, 0.05)

炎 = 3Dエミッター作成()
3Dエミッター位置(炎, 0, 0, 0)
3D発射率設定(炎, 80)
3D寿命設定(炎, 1.2)
3D速度設定(炎, 0, 3, 0, 0.5)
3D重力設定(炎, 0, 0.5, 0)
3D粒子色設定(炎, 1.0, 0.5, 0.0, 1.0)
3D粒子終色設定(炎, 1.0, 0.0, 0.0, 0.0)
3D粒子サイズ設定(炎, 0.15)
3Dエミッター有効(炎, 真)

ループ {
  もし(3D更新() == 偽) { 抜ける }
  3Dエミッター更新(炎)
  3D描画開始(0.02, 0.02, 0.04)
  3D描画終了()
}

3Dエミッター削除(炎)
3Dウィンドウ削除()
```

### キーフレームアニメーション + シーングラフ

```jp
プラグイン読込("engine_3d")

3Dウィンドウ作成("アニメーション", 800, 600)
3D視野設定(60, 0.1, 200)
3Dカメラ設定(0, 3, 10,  0, 1, 0)
3D環境光設定(0.2, 0.2, 0.2)
3D平行光設定(0.5, -1, 0.3,  1,1,0.9)

// シーングラフ構築
体 = 3Dノード作成()
腕 = 3Dノード作成()
3D親設定(腕, 体)
3Dノード位置(腕, 1.2, 0, 0)

体_メッシュ = 3Dキューブ作成(1, 1.5, 0.5)
腕_メッシュ = 3Dキューブ作成(0.3, 1.0, 0.3)
3Dノードメッシュ設定(体, 体_メッシュ)
3Dノードメッシュ設定(腕, 腕_メッシュ)

// 体アニメ
アニメ = 3Dアニメ作成()
3D位置キー追加(アニメ, 0.0, 0, 0, 0)
3D位置キー追加(アニメ, 1.0, 0, 1, 0)
3D位置キー追加(アニメ, 2.0, 0, 0, 0)
3D回転キー追加(アニメ, 0.0, 0, 0, 0)
3D回転キー追加(アニメ, 1.0, 0, 90, 0)
3D回転キー追加(アニメ, 2.0, 0, 0, 0)
3Dループ設定(アニメ, 真)
3Dアニメ再生(アニメ, 体)

ループ {
  もし(3D更新() == 偽) { 抜ける }
  3Dアニメ更新(アニメ)
  3D描画開始(0.05, 0.05, 0.1)
  3Dノード描画(体)
  3D描画終了()
}

3Dアニメ削除(アニメ)
3Dノード削除(腕)
3Dノード削除(体)
3Dウィンドウ削除()
```

### フライカメラ + フォグ

```jp
プラグイン読込("engine_3d")

3Dウィンドウ作成("フライカメラ", 1024, 768)
3D視野設定(70, 0.1, 500)

// フォグ (exp2, 密度0.05, 灰色)
3Dフォグ有効(2, 0.05, 0, 0,  0.6, 0.6, 0.6)

地面 = 3D平面作成(100, 100)
3Dメッシュ色設定(地面, 0.3, 0.5, 0.3, 1.0)

カメラX = 0.0
カメラY = 2.0
カメラZ = 5.0
ヨー   = 0.0
ピッチ = 0.0

3Dマウス相対モード(真)

ループ {
  もし(3D更新() == 偽) { 抜ける }
  dt = 3Dデルタ時間()
  速度 = 10.0 * dt

  ヨー   = ヨー   - 3Dマウス DX() * 0.15
  ピッチ = ピッチ - 3Dマウス DY() * 0.15

  もし(3Dキー押下中("w")) {
    カメラX = カメラX + 数学sin(ヨー * 3.14159265 / 180) * 速度
    カメラZ = カメラZ - 数学cos(ヨー * 3.14159265 / 180) * 速度
  }
  もし(3Dキー押下中("s")) {
    カメラX = カメラX - 数学sin(ヨー * 3.14159265 / 180) * 速度
    カメラZ = カメラZ + 数学cos(ヨー * 3.14159265 / 180) * 速度
  }
  もし(3Dキー押下中("スペース")) { カメラY = カメラY + 速度 }
  もし(3Dキー押下中("左Ctrl"))   { カメラY = カメラY - 速度 }

  前向X = 数学sin(ヨー * 3.14159265 / 180) * 数学cos(ピッチ * 3.14159265 / 180)
  前向Y = 数学sin(ピッチ * 3.14159265 / 180)
  前向Z = -数学cos(ヨー * 3.14159265 / 180) * 数学cos(ピッチ * 3.14159265 / 180)
  3Dカメラ設定(カメラX, カメラY, カメラZ,
               カメラX + 前向X, カメラY + 前向Y, カメラZ + 前向Z)

  3D描画開始(0.6, 0.6, 0.6)
  3Dメッシュ描画(地面, 0,0,0,  0,0,0,  1,1,1)
  3D描画終了()
}
3Dウィンドウ削除()
```

### ライフサイクル

| 関数 | 引数 | 戻り値 | 説明 |
|---|---|---|---|
| `3Dウィンドウ作成(タイトル, 幅, 高さ)` | str, int, int | 真/偽 | OpenGL ウィンドウ生成 |
| `3Dウィンドウ削除()` | — | null | 全リソース解放 |
| `3D更新()` | — | 真/偽 | イベント処理。終了要求で偽 |
| `3Dデルタ時間()` | — | float | 前フレームからの経過秒 |
| `3DFPS()` | — | int | 直近の FPS |

### カメラ

| 関数 | 引数 | 説明 |
|---|---|---|
| `3Dカメラ設定(ex,ey,ez, tx,ty,tz)` | 6×float | eye 位置と注視点を同時設定 |
| `3Dカメラ位置(x, y, z)` | 3×float | カメラ位置のみ設定 |
| `3Dカメラ向き(tx, ty, tz)` | 3×float | 注視点のみ設定 |
| `3D視野設定(fov, near, far)` | 3×float | FOV(度)・クリップ距離 |

### メッシュ生成

| 関数 | 引数 | 戻り値 | 説明 |
|---|---|---|---|
| `3Dキューブ作成(w, h, d)` | 3×float | メッシュID | 直方体 |
| `3D球体作成(r, slices, stacks)` | float, int, int | メッシュID | 球 |
| `3D平面作成(w, d)` | 2×float | メッシュID | XZ 平面 |
| `3D円柱作成(r, h, slices)` | float, float, int | メッシュID | 円柱 |
| `3Dカプセル作成(r, h, slices)` | float, float, int | メッシュID | カプセル |
| `3Dトーラス作成(R, r, seg, sides)` | 2×float, 2×int | メッシュID | トーラス |
| `3DOBJ読込(パス)` | str | メッシュID | .obj ファイル読込 |
| `3Dメッシュ削除(id)` | int | null | メッシュ解放 |
| `3Dメッシュ頂点数(id)` | int | int | 頂点数取得 |

### マテリアル / テクスチャ

| 関数 | 引数 | 説明 |
|---|---|---|
| `3Dメッシュ色設定(id, r, g, b, a)` | int, 4×float | ベースカラー (0.0〜1.0) |
| `3Dメッシュテクスチャ(mesh_id, tex_id)` | 2×int | テクスチャ貼り付け。0 で解除 |
| `3D法線マップ設定(mesh_id, tex_id)` | 2×int | 法線マップ貼り付け |
| `3Dスペキュラー設定(mesh_id, 強度, 鋭さ)` | int, 2×float | スペキュラー反射 |
| `3D発光設定(mesh_id, r,g,b, 強度)` | int, 4×float | エミッシブ自発光 |
| `3Dワイヤーフレーム(mesh_id, 有効)` | int, 真/偽 | ワイヤーフレーム表示切替 |
| `3D影投射設定(mesh_id, 有効)` | int, 真/偽 | シャドウキャスト |
| `3D影受取設定(mesh_id, 有効)` | int, 真/偽 | シャドウレシーブ |
| `3D透明設定(mesh_id, 有効)` | int, 真/偽 | アルファブレンド有効化 |
| `3Dテクスチャ読込(パス)` | str | テクスチャID | PNG/JPG/BMP |
| `3Dテクスチャ削除(id)` | int | null | テクスチャ解放 |

### 照明

| 関数 | 引数 | 説明 |
|---|---|---|
| `3D環境光設定(r, g, b)` | 3×float | 全体の環境光 |
| `3D平行光設定(dx,dy,dz, r,g,b)` | 6×float | 平行ライト (方向 + 色) |
| `3Dポイントライト設定(slot, x,y,z, r,g,b, radius)` | int, 7×float | 点光源 (slot=0〜7, radius=0 で無効) |
| `3Dスポットライト設定(slot, x,y,z, dx,dy,dz, r,g,b, inner, outer, radius)` | int, 11×float | スポットライト (slot=0〜3) |
| `3Dスポットライト削除(slot)` | int | スポットライト無効化 |

### シャドウ / フォグ / ブルーム

| 関数 | 引数 | 説明 |
|---|---|---|
| `3Dシャドウ有効(有効)` | 真/偽 | PCF ソフトシャドウ on/off |
| `3Dシャドウバイアス(bias)` | float | 深度バイアス (既定 0.005) |
| `3Dシャドウサイズ(size)` | int | デプスマップ解像度 (既定 2048) |
| `3Dフォグ有効(mode, density, near, far, r,g,b)` | int, 6×float | フォグ設定 (mode: 0=linear, 1=exp, 2=exp2, -1=off) |
| `3Dブルーム有効(有効)` | 真/偽 | ブルーム on/off |
| `3Dブルーム閾値(threshold)` | float | ブルーム輝度閾値 (既定 1.0) |
| `3Dブルーム強度(intensity)` | float | ブルーム混合強度 (既定 1.0) |

### スカイボックス

| 関数 | 引数 | 説明 |
|---|---|---|
| `3Dスカイボックス読込(right, left, top, bottom, front, back)` | 6×str | キューブマップ 6 面読込 |
| `3Dスカイボックス描画(有効)` | 真/偽 | スカイボックス表示切替 |
| `3Dスカイボックス解放()` | — | キューブマップ解放 |

### 描画

| 関数 | 引数 | 説明 |
|---|---|---|
| `3D描画開始(r, g, b)` | 3×float | フレーム開始・背景色 |
| `3Dメッシュ描画(id, px,py,pz, rx,ry,rz, sx,sy,sz)` | int, 9×float | メッシュ描画 (位置・回転(度)・スケール) |
| `3D描画終了()` | — | ブルーム合成・スワップ |

### パーティクル

| 関数 | 引数 | 戻り値 | 説明 |
|---|---|---|---|
| `3Dエミッター作成()` | — | エミッターID | パーティクルエミッター生成 |
| `3Dエミッター削除(id)` | int | null | 解放 |
| `3Dエミッター位置(id, x,y,z)` | int, 3×float | 発生位置 |
| `3D発射率設定(id, rate)` | int, float | 1 秒あたりの発生数 |
| `3D寿命設定(id, lifetime)` | int, float | 粒子の生存秒数 |
| `3D速度設定(id, vx,vy,vz, spread)` | int, 4×float | 初速ベクトル + ばらつき |
| `3D重力設定(id, gx,gy,gz)` | int, 3×float | 加速度 |
| `3D粒子色設定(id, r,g,b,a)` | int, 4×float | 開始色 |
| `3D粒子終色設定(id, r,g,b,a)` | int, 4×float | 終了色 (フェード) |
| `3D粒子サイズ設定(id, size)` | int, float | 粒子サイズ |
| `3D粒子テクスチャ設定(id, tex_id)` | 2×int | 粒子テクスチャ |
| `3Dエミッター有効(id, 有効)` | int, 真/偽 | 放出 on/off |
| `3D一斉発射(id, 数)` | 2×int | 一度に複数放出 |
| `3Dエミッター更新(id)` | int | 粒子シミュレーション更新 |

### シーングラフ

| 関数 | 引数 | 戻り値 | 説明 |
|---|---|---|---|
| `3Dノード作成()` | — | ノードID | シーンノード生成 |
| `3Dノード削除(id)` | int | null | 解放 |
| `3D親設定(child_id, parent_id)` | 2×int | 親子関係設定 |
| `3Dノードメッシュ設定(node_id, mesh_id)` | 2×int | メッシュ紐付け |
| `3Dノード位置(id, x,y,z)` | int, 3×float | ローカル位置 |
| `3Dノード回転(id, rx,ry,rz)` | int, 3×float | ローカル回転 (度) |
| `3Dノード拡縮(id, sx,sy,sz)` | int, 3×float | ローカルスケール |
| `3Dノード有効(id, 有効)` | int, 真/偽 | 表示切替 |
| `3Dノード描画(id)` | int | 子ノードを再帰描画 |
| `3Dワールド位置取得(id)` | int | [x,y,z] | ワールド座標取得 |

### アニメーション

| 関数 | 引数 | 戻り値 | 説明 |
|---|---|---|---|
| `3Dアニメ作成()` | — | アニメID | アニメーション生成 |
| `3Dアニメ削除(id)` | int | null | 解放 |
| `3D位置キー追加(anim_id, 時刻, x,y,z)` | int, 4×float | 位置キーフレーム |
| `3D回転キー追加(anim_id, 時刻, rx,ry,rz)` | int, 4×float | 回転キーフレーム (度) |
| `3Dスケールキー追加(anim_id, 時刻, sx,sy,sz)` | int, 4×float | スケールキーフレーム |
| `3Dアニメ再生(anim_id, node_id)` | 2×int | 再生開始 |
| `3Dアニメ停止(id)` | int | 停止 |
| `3Dループ設定(id, 有効)` | int, 真/偽 | ループ再生切替 |
| `3Dシーク(id, 時刻)` | int, float | 再生位置変更 |
| `3Dアニメ更新(id)` | int | フレーム更新 |
| `3D再生中(id)` | int | 真/偽 | 再生状態確認 |
| `3Dアニメ位置取得(id)` | int | [x,y,z] | 現在フレームの位置 |
| `3Dアニメ回転取得(id)` | int | [x,y,z] | 現在フレームの回転 |
| `3Dアニメスケール取得(id)` | int | [x,y,z] | 現在フレームのスケール |

### レイキャスト

| 関数 | 引数 | 戻り値 | 説明 |
|---|---|---|---|
| `3Dレイキャスト(ox,oy,oz, dx,dy,dz, mesh_id)` | 6×float, int | [hit, t, nx,ny,nz] | ワールドレイ → AABB 判定 |
| `3D画面レイキャスト(sx, sy, mesh_id)` | 2×float, int | [hit, t, nx,ny,nz] | スクリーン座標 → ワールドレイ変換後判定 |

### 入力

| 関数 | 引数 | 戻り値 | 説明 |
|---|---|---|---|
| `3Dキー押下中(キー名)` | str | 真/偽 | キーが押されている間 |
| `3Dキー押した(キー名)` | str | 真/偽 | このフレームで押した瞬間 |
| `3Dキー離した(キー名)` | str | 真/偽 | このフレームで離した瞬間 |
| `3Dマウス X()` | — | float | マウス X 座標 |
| `3Dマウス Y()` | — | float | マウス Y 座標 |
| `3Dマウス DX()` | — | float | マウス X 移動量 |
| `3Dマウス DY()` | — | float | マウス Y 移動量 |
| `3Dスクロール()` | — | float | スクロール量 |
| `3Dマウスボタン押下中(番号)` | int | 真/偽 | 1=左, 2=中, 3=右 |
| `3Dマウスボタン押した(番号)` | int | 真/偽 | このフレームで押した瞬間 |
| `3Dマウス相対モード(有効)` | 真/偽 | カーソル非表示・相対取得 |

キー名: `"w"` `"a"` `"s"` `"d"` `"q"` `"e"` `"上"` `"下"` `"左"` `"右"` `"スペース"` `"0"`〜`"9"` など


---

## ライセンス

[MIT License](LICENSE) — Copyright (c) 2026 Reo Shiozawa
